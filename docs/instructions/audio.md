# M14: Audio System - Instruction File

## Purpose

Music and SFX playback using Maxmod library. Area-based music switching on room transitions. Priority system for SFX.

## Dependencies

- `include/sm_types.h`
- `include/audio.h` (MusicID, SfxID enums, function declarations)
- Maxmod library (`-lmm9`, included via Makefile AUDIO variable)
- Soundbank generated by mmutil at build time

## Shared Types

```c
typedef enum {
    MUSIC_NONE = 0,
    MUSIC_TITLE,
    MUSIC_CRATERIA_SURFACE,
    /* ... see audio.h for full list ... */
    MUSIC_COUNT
} MusicID;

typedef enum {
    SFX_NONE = 0,
    SFX_BEAM,
    SFX_MISSILE,
    /* ... see audio.h for full list ... */
    SFX_COUNT
} SfxID;
```

## Implementation

### audio_init()
```c
mmInitDefaultMem((mm_addr)soundbank_bin);
```
The soundbank is embedded via bin2o from the `audio/` directory.

### audio_play_music(MusicID id)
```c
if (id == MUSIC_NONE) { mmStop(); return; }
mmStart(id - 1, MM_PLAY_LOOP);  /* -1 because MUSIC_NONE=0 */
```

### audio_stop_music()
```c
mmStop();
```

### audio_play_sfx(SfxID id)
```c
mmEffect(id - 1);  /* maps to soundbank effect index */
```

## Audio Pipeline

SNES audio uses BRR samples played through the SPC700. For DS:
1. Extract BRR samples from ROM (`tools/brr_extract.py`)
2. Convert BRR to WAV (`tools/brr_to_wav.py`)
3. Convert WAV/MOD/XM to Maxmod soundbank (`mmutil`)
4. Soundbank embedded in ROM via bin2o

If full SPC sequence conversion is too complex, pre-rendered WAV tracks are acceptable.

## Constraints

- No dynamic allocation. Maxmod handles its own memory from a static buffer.
- SFX priority: player > weapons > enemies > ambient.
- Music loops seamlessly.
- Area music changes on room_load() calls.

## Test Criteria

- Title music plays on boot.
- Area music switches when entering new area.
- SFX plays without cutting music.
- No audio dropouts at 60fps.
